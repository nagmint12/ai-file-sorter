name: Build (Windows EXE)

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 1) MSVC 환경 세팅
      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # 2) Qt 설치 (Windows)
      - name: Set up Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.3'
          host: windows
          target: desktop
          arch: win64_msvc2019_64

      # 3) vcpkg 설치
      - name: Install vcpkg
        uses: lukka/run-vcpkg@v11

      # 4) 의존성 설치 (Windows용)
      - name: Install dependencies with vcpkg
        run: |
          vcpkg install curl jsoncpp sqlite3 openssl fmt spdlog

      # 5) CMake Configure (Windows + MSVC)
      - name: Configure
        run: |
          cmake -S app -B build ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_TOOLCHAIN_FILE=%VCPKG_ROOT%\scripts\buildsystems\vcpkg.cmake

      # 6) Build
      - name: Build
        run: cmake --build build --config Release

      # 7) Test (선택)
      - name: Run ctest
        run: |
          cd build
          ctest -C Release --output-on-failure

      # 8) EXE 업로드
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-file-sorter-windows-exe
          path: |
            build\Release\*.exe
